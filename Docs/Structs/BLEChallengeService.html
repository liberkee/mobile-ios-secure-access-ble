<!DOCTYPE html>
<html lang="en">
  <head>
    <title>BLEChallengeService Struct Reference</title>
    <link rel="stylesheet" type="text/css" href="../css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="../css/highlight.css" />
    <meta charset='utf-8'>
    <script src="../js/jquery.min.js" defer></script>
    <script src="../js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a name="//apple_ref/swift/Struct/BLEChallengeService" class="dashAnchor"></a>
    <a title="BLEChallengeService Struct Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="../index.html">SecureAccessBLE Docs</a> (100% documented)</p>
        <p class="header-right"><a href="https://github.com/hufsm/mobile-ios-ble"><img src="../img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="../index.html">SecureAccessBLE Reference</a>
        <img id="carat" src="../img/carat.png" />
        BLEChallengeService Struct Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="../Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="../Classes/BLEComManager.html">BLEComManager</a>
              </li>
              <li class="nav-group-task">
                <a href="../Classes/BLEScanner.html">BLEScanner</a>
              </li>
              <li class="nav-group-task">
                <a href="../Classes/DataFramePackage.html">DataFramePackage</a>
              </li>
              <li class="nav-group-task">
                <a href="../Classes/SIDCommunicator.html">SIDCommunicator</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="../Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="../Enums/BLEChallengerError.html">BLEChallengerError</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/ConnectionState.html">ConnectionState</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/DataFrameType.html">DataFrameType</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/EncryptionState.html">EncryptionState</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/SIDMessageID.html">SIDMessageID</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/ServiceGrantFeature.html">ServiceGrantFeature</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/ServiceGrantID.html">ServiceGrantID</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/ServiceGrantTriggerStatus.html">ServiceGrantTriggerStatus</a>
              </li>
              <li class="nav-group-task">
                <a href="../Enums/TestMessageType.html">TestMessageType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="../Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="../Extensions/CBCentralManagerState.html">CBCentralManagerState</a>
              </li>
              <li class="nav-group-task">
                <a href="../Extensions/String.html">String</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="../Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="../Functions.html#/s:ZF15SecureAccessBLEoi2eeFTVS_3SIDS0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="../Functions.html#/s:F15SecureAccessBLE5DelayFTSd7closureFT_T__T_">Delay(_:closure:)</a>
              </li>
              <li class="nav-group-task">
                <a href="../Functions.html#/s:F15SecureAccessBLE10consoleLogFSST_">consoleLog(_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="../Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="../Protocols/BLEChallengeServiceDelegate.html">BLEChallengeServiceDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/BLEManagerDelegate.html">BLEManagerDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/ConsoleLogger.html">ConsoleLogger</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/CryptoManager.html">CryptoManager</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/DataTransfer.html">DataTransfer</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/DataTransferDelegate.html">DataTransferDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/SIDCommunicatorDelegate.html">SIDCommunicatorDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/SIDMessagePayload.html">SIDMessagePayload</a>
              </li>
              <li class="nav-group-task">
                <a href="../Protocols/ServiceGrant.html">ServiceGrant</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="../Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="../Structs/AesCbcCryptoManager.html">AesCbcCryptoManager</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/AesCbcTestCryptoManager.html">AesCbcTestCryptoManager</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/BLEChallengeService.html">BLEChallengeService</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/BLEHelper.html">BLEHelper</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/BlobRequest.html">BlobRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/CryptoHeader.html">CryptoHeader</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/CryptoHeader/CryptoMessageDirection.html">– CryptoMessageDirection</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/DataFrame.html">DataFrame</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/EmptyPayload.html">EmptyPayload</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/Handshake.html">Handshake</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/LTBlobPayload.html">LTBlobPayload</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/MTUSize.html">MTUSize</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/NoPadding.html">NoPadding</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/PhoneToSidChallenge.html">PhoneToSidChallenge</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/PhoneToSidResponse.html">PhoneToSidResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/SID.html">SID</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/SIDMessage.html">SIDMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ServiceGrantRequest.html">ServiceGrantRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ServiceGrantTrigger.html">ServiceGrantTrigger</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ServiceGrantTrigger/ServiceGrantStatus.html">– ServiceGrantStatus</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ServiceGrantTrigger/ServiceGrantResult.html">– ServiceGrantResult</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/SidToPhoneResponse.html">SidToPhoneResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/TestMessage.html">TestMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ZeroByte.html">ZeroByte</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ZeroByteWithLength.html">ZeroByteWithLength</a>
              </li>
              <li class="nav-group-task">
                <a href="../Structs/ZeroSecurityManager.html">ZeroSecurityManager</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            <h1>BLEChallengeService</h1>
              <div class="declaration">
                <div class="language">
                  <pre class="highlight"><code><span class="kd">struct</span> <span class="kt">BLEChallengeService</span></code></pre>

                </div>
              </div>
            <p>BLE ChallengeService provides a mutual challenge / response mechanism. 
The challenge response mecfhanism shall mutually authenticate SID and smart device.
A session key will be resulted to encrypt the SID smart device communication.
prerequistite shall be that the smart device and SID posses a symmetric pre-shared key, that
shall be provided by the secure access platform via the distributed lease token.
The lease token should be encrypted with public key of smart device and SID and
signed by the platform server.
More infos for challenge response protocol see also the reference:
<a href="https://www.emsec.rb.de/media/crypto/veroeffentlichungen/2011/11/16/chameleon.pdf">https://www.emsec.rb.de/media/crypto/veroeffentlichungen/2011/11/16/chameleon.pdf</a>
The challenge response mechanism shall operate as follow:</p>

<ol>
<li>The smartphone (App) picks a random 128-bit nonce nc and AES-encrypts nc with shared AES key: k(auth) results b0.</li>
<li>b0 is sent to the SID</li>
<li>SID decryts b0 r0 = encAES(k(auth), b0)</li>
<li>SID permutes r0 r1 = P(r0)</li>
<li>SID picks a random 128-bit nonce nr and encrypts nr in CBC mode b1 = encAES(k(auth), nr XOR b0)</li>
<li>SID encrypts r1 in CBC mode b2 = encAES(k(auth); r1 XOR b1)</li>
<li>SID sends b1 and b2 to the Smartphone App.</li>
<li>The App decryts b2 in CBC mode: r3 = decAES (k(auth); b2) XOR b1</li>
<li>The App checks if permuted noce is valid: P(invert)(r3) = nc, if not the protocol is aborted, if equal, the
SID noce is decrypted: r4 = decAES(k(auth); b1) XOR b0</li>
<li>The decrypted nonce is permuted: r5 = P(r4) and AES-encrypted: b3 = encAES(k(auth); r5 XOR b2)</li>
<li>b3 is sent to SID</li>
<li>SID decrypts b3: r6 = decAES(k(auth); b3) XOR b2</li>
<li>SID checks if the permuted nonce is valid: if P(invert)(r6) does not equal to nr, the protoco is aborted,
if equal, the authentication is complete</li>
<li>Both SID and App have the same session key:
ks = nr[0&hellip;3] || nc[0&hellip;3] || nr[12&hellip;15] || nc[12&hellip;15]</li>
</ol>

<p>note: || indicates concatenation and a[i&hellip;j] indicates the bytes &lsquo;i&rsquo; to &lsquo;j&rsquo; of an array a</p>

          </section>
          <section class="section task-group-section">
            <div class="task-group">
              <ul>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:vV15SecureAccessBLE19BLEChallengeService8delegateGSqPS_27BLEChallengeServiceDelegate__"></a>
                    <a name="//apple_ref/swift/Property/delegate" class="dashAnchor"></a>
                    <a class="token" href="#/s:vV15SecureAccessBLE19BLEChallengeService8delegateGSqPS_27BLEChallengeServiceDelegate__">delegate</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>Challenger Service Delegate object</p>

                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt"><a href="../Protocols/BLEChallengeServiceDelegate.html">BLEChallengeServiceDelegate</a></span><span class="p">?</span></code></pre>

                        </div>
                      </div>
                    </section>
                  </div>
                </li>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:FV15SecureAccessBLE19BLEChallengeServicecFT8deviceIdSS5sidIdSS12leaseTokenIdSS12sidAccessKeySS_GSqS0__"></a>
                    <a name="//apple_ref/swift/Method/init(deviceId:sidId:leaseTokenId:sidAccessKey:)" class="dashAnchor"></a>
                    <a class="token" href="#/s:FV15SecureAccessBLE19BLEChallengeServicecFT8deviceIdSS5sidIdSS12leaseTokenIdSS12sidAccessKeySS_GSqS0__">init(deviceId:sidId:leaseTokenId:sidAccessKey:)</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>init function for BLE Challenger object</p>

                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="nf">init</span><span class="p">?(</span><span class="nv">deviceId</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">sidId</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">leaseTokenId</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">sidAccessKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span></code></pre>

                        </div>
                      </div>
                      <div>
                        <h4>Parameters</h4>
                        <table class="graybox">
                          <tbody>
                            <tr>
                              <td>
                                <code>
                                <em>deviceId</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>device id as String see also Moddel: SecureAccess.deviceId</p>

                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <code>
                                <em>sidId</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>sid id as String see also Moddel: SecureAccess.sidId</p>

                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <code>
                                <em>leaseTokenId</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>lease token id as String see also Moddel: SecureAccess.leaseTokenId</p>

                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <code>
                                <em>sidAccessKey</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>sid access key as String see also Moddel: SecureAccess.sidAccessKey</p>

                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <div>
                        <h4>Return Value</h4>
                        <p>new object for BLE Challenger</p>

                      </div>
                    </section>
                  </div>
                </li>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:FV15SecureAccessBLE19BLEChallengeService14beginChallengeFzT_T_"></a>
                    <a name="//apple_ref/swift/Method/beginChallenge()" class="dashAnchor"></a>
                    <a class="token" href="#/s:FV15SecureAccessBLE19BLEChallengeService14beginChallengeFzT_T_">beginChallenge()</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>Should only be called, when a BLE Challenger should be started.</p>

<div class="aside aside-throws">
    <p class="aside-title">Throws</p>
    Challenger Error if Encryption failed

</div>

                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="k">mutating</span> <span class="kd">func</span> <span class="nf">beginChallenge</span><span class="p">()</span> <span class="k">throws</span></code></pre>

                        </div>
                      </div>
                    </section>
                  </div>
                </li>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:FV15SecureAccessBLE19BLEChallengeService31handleReceivedChallengerMessageFzVS_10SIDMessageT_"></a>
                    <a name="//apple_ref/swift/Method/handleReceivedChallengerMessage(_:)" class="dashAnchor"></a>
                    <a class="token" href="#/s:FV15SecureAccessBLE19BLEChallengeService31handleReceivedChallengerMessageFzVS_10SIDMessageT_">handleReceivedChallengerMessage(_:)</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>Handles all incoming challenge responses from SID.</p>

<div class="aside aside-throws">
    <p class="aside-title">Throws</p>
    <p>throws:</p>

</div>

                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="k">mutating</span> <span class="kd">func</span> <span class="nf">handleReceivedChallengerMessage</span><span class="p">(</span><span class="nv">response</span><span class="p">:</span> <span class="kt"><a href="../Structs/SIDMessage.html">SIDMessage</a></span><span class="p">)</span> <span class="k">throws</span></code></pre>

                        </div>
                      </div>
                      <div>
                        <h4>Parameters</h4>
                        <table class="graybox">
                          <tbody>
                            <tr>
                              <td>
                                <code>
                                <em>response</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>received response as SID message</p>

                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </section>
                  </div>
                </li>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:FV15SecureAccessBLE19BLEChallengeService6rotateFTGSaVs5UInt8_7inverseSb_GSaS1__"></a>
                    <a name="//apple_ref/swift/Method/rotate(_:inverse:)" class="dashAnchor"></a>
                    <a class="token" href="#/s:FV15SecureAccessBLE19BLEChallengeService6rotateFTGSaVs5UInt8_7inverseSb_GSaS1__">rotate(_:inverse:)</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>Mathmatic calculation for (inverse)rotation of incomming bytes (Matrix)</p>

                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="kd">func</span> <span class="nf">rotate</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">],</span> <span class="nv">inverse</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">]</span></code></pre>

                        </div>
                      </div>
                      <div>
                        <h4>Parameters</h4>
                        <table class="graybox">
                          <tbody>
                            <tr>
                              <td>
                                <code>
                                <em>bytes</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>incomming bytes that should be reteted</p>

                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <code>
                                <em>inverse</em>
                                </code>
                              </td>
                              <td>
                                <div>
                                  <p>inverse or not as bool</p>

                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <div>
                        <h4>Return Value</h4>
                        <p>new rotated bytes (Matrix)</p>

                      </div>
                    </section>
                  </div>
                </li>
              </ul>
            </div>
          </section>
        </section>
        <section id="footer">
          <p>&copy; 2016 <a class="link" href="" target="_blank" rel="external">Huf Secure Mobile GmbH</a>. All rights reserved. (Last updated: 2016-10-03)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.2</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
